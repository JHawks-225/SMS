<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Chat de Classe</title>
  <link rel="stylesheet" href="style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="container" id="register">
  <h1>ğŸ“ Inscription</h1>
  <input type="text" id="nom" placeholder="Nom rÃ©el">
  <input type="text" id="pseudo" placeholder="Pseudo">
  <input type="text" id="numero" placeholder="NumÃ©ro">
  <label><input type="checkbox" id="visibleNom"> Nom public</label>
  <button onclick="inscription()">Envoyer</button>
</div>

<div class="container" id="waiting" style="display:none;">
  <h1>â³ Validation en cours...</h1>
</div>

<div class="app" id="chat" style="display:none;">
  <aside class="sidebar">
    <h2>ğŸ’¬ Chat</h2>
    <button onclick="openGeneral()"># GÃ©nÃ©ral</button>
    <button onclick="openPrivate()">ğŸ‘¤ PrivÃ©</button>
    <button onclick="openGroup()">ğŸ‘¥ Groupe</button>
    <hr>
    <h3>Utilisateurs</h3>
    <ul id="users"></ul>
  </aside>

  <main class="chat">
    <header class="chat-header"><h2 id="chat-title">Discussion gÃ©nÃ©rale</h2></header>
    <div class="messages" id="messages"></div>
    <div class="input-zone">
      <input type="text" id="messageInput" placeholder="Messageâ€¦">
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </main>
</div>

<script>
const socket = io();
let currentType = "general";
let currentRecipient = null;
let monPseudo = localStorage.getItem("monPseudo");

if (localStorage.getItem("status") === "accepted") showChat();

function inscription() {
  const p = document.getElementById("pseudo").value;
  const user = {
    nom: document.getElementById("nom").value,
    pseudo: p,
    numero: document.getElementById("numero").value,
    visibleNom: document.getElementById("visibleNom").checked
  };
  fetch("/register", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(user)
  }).then(() => {
    monPseudo = p;
    localStorage.setItem("monPseudo", p);
    localStorage.setItem("status", "waiting");
    showWaiting();
  });
}

function showWaiting() {
  document.getElementById("register").style.display = "none";
  document.getElementById("waiting").style.display = "block";
}

function showChat() {
  document.getElementById("register").style.display = "none";
  document.getElementById("waiting").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  socket.emit("registerSocket", monPseudo);
}

// Fonctions demandÃ©es
function openGeneral() {
  currentType = "general";
  document.getElementById("chat-title").textContent = "Discussion gÃ©nÃ©rale";
  document.getElementById("messages").innerHTML = "";
}

function openPrivate() {
  const dest = prompt("Pseudo du destinataire ?");
  if (dest) {
    currentType = "private";
    currentRecipient = dest;
    document.getElementById("chat-title").textContent = "PrivÃ© avec " + dest;
    document.getElementById("messages").innerHTML = "";
  }
}

function openGroup() {
  const g = prompt("Nom du groupe ?");
  if (g) alert("Groupe '" + g + "' crÃ©Ã© (FonctionnalitÃ© visuelle)");
}

function sendMessage() {
  const input = document.getElementById("messageInput");
  if (!input.value) return;
  
  const msgData = {
    type: currentType,
    from: monPseudo,
    to: currentRecipient,
    text: input.value
  };
  
  socket.emit("message", msgData);
  input.value = "";
}

socket.on("message", (data) => {
  const d = document.createElement("div");
  d.className = data.from === monPseudo ? "message me" : "message";
  d.innerHTML = `<strong>${data.from}:</strong> ${data.text}`;
  document.getElementById("messages").appendChild(d);
});

socket.on("onlineUsers", (list) => {
  const ui = document.getElementById("users");
  ui.innerHTML = list.map(u => `<li>${u}</li>`).join("");
});

// VÃ©rification auto admin
setInterval(() => {
  if (localStorage.getItem("status") === "waiting") {
    fetch(`/status?pseudo=${monPseudo}`).then(r => r.json()).then(res => {
      if (res.accepted) {
        localStorage.setItem("status", "accepted");
        showChat();
      }
    });
  }
}, 3000);
</script>
</body>
</html>
