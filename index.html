<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chat de Classe</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div class="container" id="register">
  <h1>ğŸ“ Inscription</h1>
  <input type="text" id="nom" placeholder="Nom rÃ©el">
  <input type="text" id="pseudo" placeholder="Pseudo">
  <input type="text" id="numero" placeholder="NumÃ©ro">
  <label><input type="checkbox" id="visibleNom"> Afficher mon nom</label>
  <button onclick="inscription()">Envoyer la demande</button>
</div>

<div class="container" id="waiting" style="display:none;">
  <h1>â³ En attente</h1>
  <p>L'administrateur doit valider votre compte...</p>
</div>

<div class="app" id="chat" style="display:none;">
  <aside class="sidebar">
    <h2>ğŸ’¬ Chat</h2>
    <ul id="users"></ul>
  </aside>
  <main class="chat">
    <header class="chat-header"><h2 id="chat-title">GÃ©nÃ©ral</h2></header>
    <div class="messages" id="messages"></div>
    <div class="input-zone">
      <input type="text" id="messageInput" placeholder="Message...">
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </main>
</div>

<script>
const socket = io();
let monPseudo = localStorage.getItem("monPseudo");

if (localStorage.getItem("status") === "accepted") showChat();

function inscription() {
  const p = document.getElementById("pseudo").value;
  const data = {
    nom: document.getElementById("nom").value,
    pseudo: p,
    numero: document.getElementById("numero").value,
    visibleNom: document.getElementById("visibleNom").checked
  };

  fetch("/register", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  }).then(() => {
    monPseudo = p;
    localStorage.setItem("monPseudo", p);
    localStorage.setItem("status", "waiting");
    showWaiting();
  });
}

function showWaiting() {
  document.getElementById("register").style.display = "none";
  document.getElementById("waiting").style.display = "block";
}

function showChat() {
  document.getElementById("register").style.display = "none";
  document.getElementById("waiting").style.display = "none";
  document.getElementById("chat").style.display = "flex";
  socket.emit("registerSocket", monPseudo);
}

// VÃ©rification auto du statut
setInterval(() => {
  if (localStorage.getItem("status") === "waiting") {
    fetch(`/status?pseudo=${monPseudo}`)
      .then(r => r.json())
      .then(res => {
        if (res.accepted) {
          localStorage.setItem("status", "accepted");
          showChat();
        }
      });
  }
}, 3000);

function sendMessage() {
  const input = document.getElementById("messageInput");
  if (!input.value) return;
  socket.emit("message", { from: monPseudo, text: input.value });
  input.value = "";
}

socket.on("message", data => {
  const div = document.createElement("div");
  div.className = data.from === monPseudo ? "message me" : "message";
  div.innerHTML = `<strong>${data.from}:</strong> ${data.text}`;
  document.getElementById("messages").appendChild(div);
});

socket.on("onlineUsers", list => {
  const ui = document.getElementById("users");
  ui.innerHTML = list.map(u => `<li>ğŸŸ¢ ${u}</li>`).join("");
});
</script>
</body>
</html>
