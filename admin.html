<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Panel Admin Chat</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">

  <!-- LOGIN ADMIN -->
  <div id="login">
    <h1>ğŸ” AccÃ¨s Administrateur</h1>
    <input type="password" id="code" placeholder="Code admin">
    <button onclick="login()">Entrer</button>
    <p id="error"></p>
  </div>

  <!-- PANEL ADMIN -->
  <div id="panel" style="display:none;">

    <h1>Panel Admin ğŸ‘‘</h1>

    <button onclick="logout()">DÃ©connexion</button>

    <div class="form-container">
      <h2>Demandes en attente</h2>
      <div id="list"></div>

      <button onclick="download()">TÃ©lÃ©charger l'historique</button>
    </div>

  </div>

</div>

<script>
/* ==== AUTH ADMIN ==== */
const ADMIN_CODE = "102009";

if (localStorage.getItem("admin") === "true") {
  showPanel();
}

function login() {
  const code = document.getElementById("code").value;
  if (code === ADMIN_CODE) {
    localStorage.setItem("admin", "true");
    showPanel();
  } else {
    document.getElementById("error").textContent = "âŒ Code incorrect";
  }
}

function logout() {
  localStorage.removeItem("admin");
  location.reload();
}

function showPanel() {
  document.getElementById("login").style.display = "none";
  document.getElementById("panel").style.display = "block";
  refresh();
}

/* ==== LOGIQUE ADMIN EXISTANTE ==== */
function refresh() {
  fetch("/admin/demandes")
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById("list");
      list.innerHTML = "";
      data.forEach(u => {
        const vis = u.visibleNom ? "Oui" : "Non";
        list.innerHTML += `
        <div class="demande">
          <p>
            <strong>${u.pseudo}</strong>
            (${u.nom || "â€”"}) - Visible publiquement: ${vis}
            <button onclick="valider('${u.pseudo}')">Valider</button>
          </p>
        </div>`;
      });
    });
}

function valider(pseudo) {
  fetch("/admin/valider", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({pseudo})
  }).then(refresh);
}

function download() {
  window.location = "/download";
}

// auto refresh toutes les 2s
setInterval(() => {
  if (localStorage.getItem("admin") === "true") refresh();
}, 2000);
</script>

</body>
</html>
